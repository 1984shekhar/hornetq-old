<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2009 Red Hat, Inc.
  ~ Red Hat licenses this file to you under the Apache License, version
  ~ 2.0 (the "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~    http://www.apache.org/licenses/LICENSE-2.0
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
  ~ implied.  See the License for the specific language governing
  ~ permissions and limitations under the License.
  -->

<project default="upload" name="HornetQ">
   <property name="hornetq.version" value="2.0.0.snapshot"/>
   <property name="build.dir" value="build"/>
   <property name="jars.dir" value="${build.dir}/jars"/>

   <target name="uploadHornetQBootstrap">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-bootstrap"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQCore">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-core"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQLogging">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-logging"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQTransports">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-transports"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQCoreClient">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-core-client"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQJms">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-jms"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQJmsClient">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-jms-client"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQSecurity">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-jboss-as-integration"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQRa">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-ra"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>

   <target name="uploadHornetQResources">
      <antcall target="upload">
         <param name="artifact.id" value="hornetq-resources"/>
         <param name="artifact.type" value="jar"/>
      </antcall>
   </target>


   <target name="install">
      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-resources"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-jms"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-jms-client"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-core"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-jboss-as-integration"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-bootstrap"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-core-client"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-logging"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-ra"/>
      </antcall>

      <antcall target="upload-local-target">
          <param name="artifact.id" value="hornetq-transports"/>
      </antcall>

   </target>

   <target name="upload-local-target">
       <exec executable="mvn">
        <arg value="install:install-file"/>
        <arg value="-DgroupId=org.hornetq"/>
        <arg value="-DartifactId=${artifact.id}"/>
        <arg value="-Dversion=${hornetq.version}"/>
        <arg value="-Dpackaging=jar"/>
        <arg value="-Dfile=./build/jars/${artifact.id}.jar"/>
       </exec>
   </target>

   <target name="upload">
      <exec executable="mvn">
         <arg value="-s settings.xml"/>
         <arg value="deploy:deploy-file"/>
         <arg value="-DgroupId=org.hornetq"/>
         <arg value="-DartifactId=${artifact.id}"/>
         <arg value="-Dversion=${hornetq.version}"/>
         <arg value="-Dpackaging=${artifact.type}"/>
         <arg value="-DgeneratePom=true"/>
         <arg value="-Dfile=${jars.dir}/${artifact.id}.${artifact.type}"/>
         <arg value="-DrepositoryId=snapshots.jboss.org"/>
         <arg value="-Durl=dav:https://snapshots.jboss.org/maven2"/>
      </exec>
   </target>

   <target name="updateMavenRepos">
      <fail unless="hornetq.distro" message="*** Please set the hornetq.distro property i.e. -Dhornetq.distro=foo ***"/>
      <fail unless="hornetq.repos" message="*** Please set the hornetq.repos property i.e. -Dhornetq.repos=foo ***"/>
      <property name="src.dir" value="${hornetq.distro}"/>
      <property name="dest.dir" value="${hornetq.repos}"/>

      <tstamp>
         <format property="TIMESTAMP" pattern="yyyyMMddhhmmss" locale="en,UK"/>
      </tstamp>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-bootstrap"/>
         <param name="libDir" value="${src.dir}/lib"/>
      </antcall>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-core"/>
         <param name="libDir" value="${src.dir}/lib"/>
      </antcall>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-jboss-as-integration"/>
         <param name="libDir" value="${src.dir}/lib"/>
      </antcall>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-jms"/>
         <param name="libDir" value="${src.dir}/lib"/>
      </antcall>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-logging"/>
         <param name="libDir" value="${src.dir}/lib"/>
      </antcall>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-transports"/>
         <param name="libDir" value="${src.dir}/lib"/>
      </antcall>
      <mkdir dir="tmpLib"/>
      <unjar src="${src.dir}/lib/hornetq-ra.rar" dest="tmpLib"/>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-ra"/>
         <param name="libDir" value="tmpLib"/>
      </antcall>
      <delete dir="tmpLib"/>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-core-client"/>
         <param name="libDir" value="${src.dir}/client"/>
      </antcall>
      <antcall target="copyJar">
         <param name="jarName" value="hornetq-jms-client"/> 
         <param name="libDir" value="${src.dir}/client"/>
      </antcall>
   </target>

   <target  name="copyJar">
      <mkdir dir="${dest.dir}/${jarName}/${hornetq.version}"/>
      <echo file="${dest.dir}/${jarName}/${hornetq.version}/${jarName}-${hornetq.version}.pom"
            message="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project&gt;${line.separator}
 &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;${line.separator}
 &lt;groupId&gt;org.hornetq&lt;/groupId&gt;${line.separator}
 &lt;artifactId&gt;${jarName}&lt;/artifactId&gt;${line.separator}
 &lt;version&gt;${hornetq.version}&lt;/version&gt;${line.separator}&lt;/project&gt;"/>
      <copy file="${libDir}/${jarName}.jar" tofile="${dest.dir}/${jarName}/${hornetq.version}/${jarName}-${hornetq.version}.jar"/>
      <checksum file="${dest.dir}/${jarName}/${hornetq.version}/${jarName}-${hornetq.version}.jar" algorithm="md5"/>
      <checksum file="${dest.dir}/${jarName}/${hornetq.version}/${jarName}-${hornetq.version}.jar" algorithm="sha1"/>
      <checksum file="${dest.dir}/${jarName}/${hornetq.version}/${jarName}-${hornetq.version}.pom" algorithm="md5"/>
      <checksum file="${dest.dir}/${jarName}/${hornetq.version}/${jarName}-${hornetq.version}.pom" algorithm="sha1"/>
      <replace file="${dest.dir}/${jarName}/maven-metadata.xml" token="&lt;/versions&gt;"  value="  &lt;version&gt;${hornetq.version}&lt;/version&gt;${line.separator}    &lt;/versions&gt;"/>
      <replaceregexp flags="g" file="${dest.dir}/${jarName}/maven-metadata.xml" match="&lt;lastUpdated&gt;(.+)&lt;/lastUpdated&gt;" replace="&lt;lastUpdated&gt;${TIMESTAMP}&lt;/lastUpdated&gt;"/>
      <checksum file="${dest.dir}/${jarName}/maven-metadata.xml" algorithm="md5"/>
      <checksum file="${dest.dir}/${jarName}/maven-metadata.xml" algorithm="sha1"/>
   </target>

</project>
