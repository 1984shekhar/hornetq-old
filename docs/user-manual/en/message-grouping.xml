<?xml version="1.0" encoding="UTF-8"?>

<!-- ============================================================================= -->
<!-- Copyright © 2009 Red Hat, Inc. and others.                                    -->
<!--                                                                               -->
<!-- The text of and illustrations in this document are licensed by Red Hat under  -->
<!-- a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). -->
<!--                                                                               -->
<!-- An explanation of CC-BY-SA is available at                                    -->
<!--                                                                               -->
<!--            http://creativecommons.org/licenses/by-sa/3.0/.                    -->
<!--                                                                               -->
<!-- In accordance with CC-BY-SA, if you distribute this document or an adaptation -->
<!-- of it, you must provide the URL for the original version.                     -->
<!--                                                                               -->
<!-- Red Hat, as the licensor of this document, waives the right to enforce,       -->
<!-- and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent        -->
<!-- permitted by applicable law.                                                  -->
<!-- ============================================================================= -->

<chapter id="message-grouping">
   <title>Message Grouping</title>
   <para>Message groups are sets of messages that has the following characteristics:</para>
   <itemizedlist>
      <listitem>
         <para>Messages in a message group share the same group id, i.e. they have same group
            identifier property (<literal>JMSXGroupID</literal> for JMS, <literal
               >_HQ_GROUP_ID</literal> for HornetQ Core API).</para>
      </listitem>
      <listitem>
         <para>Messages in a message group are always consumed by the same consumer, even if there
            are many consumers on a queue. They pin all messages with the same group id to the same
            consumer. If that consumer closes another consumer is chosen and will receive all
            messages with the same group id.</para>
      </listitem>
   </itemizedlist>
   <section>
      <title>Using Core API</title>
      <para>The property name used to identify the message group is <literal
            >"_HQ_GROUP_ID""</literal> (or the constant <literal
         >MessageImpl.HDR_GROUP_ID</literal>). Alternatively, you can set <literal
            >autogroup</literal> to true on the <literal>SessionFactory</literal> which will pick a
         random unique id. </para>
   </section>
   <section id="message-grouping.jmsconfigure">
      <title>Using JMS</title>
      <para>The property name used to identify the message group is <literal
         >JMSXGroupID</literal>.</para>
      <para>Within the same group, messages can also set a <literal>JMSXGroupSeq</literal>
         <literal>int</literal> property (starting at 1).</para>
      <programlisting>
 // send 2 messages in the same group to ensure the same
 // consumer will receive both
 Message message = ...
 message.setStringProperty("JMSXGroupID", "Group-0");
 message.setIntProperty("JMSXGroupSeq", 1);
 producer.send(message);

 message = ...
 message.setStringProperty("JMSXGroupID", "Group-0");
 message.setIntProperty("JMSXGroupSeq", 2);
 producer.send(message);          
       </programlisting>
      <para>Alternatively, you can set <literal>autogroup</literal> to true on the <literal
            >HornetQConnectonFactory</literal> which will pick a random unique id.  This can also be
         set in the <literal>hornetq-jms.xml</literal> file like this:</para>
      <programlisting>&lt;connection-factory name="ConnectionFactory">
      &lt;connector-ref connector-name="netty-connector"/>
      &lt;entries>
         &lt;entry name="ConnectionFactory"/>
      &lt;/entries>
      &lt;autogroup>true&lt;/autogroup>
&lt;/connection-factory></programlisting>
   </section>
   <section>
      <title>Example</title>
      <para>See <xref linkend="examples.message-group" /> for an example which 
         shows how message groups are configured and used with JMS.</para>
   </section>
</chapter>
